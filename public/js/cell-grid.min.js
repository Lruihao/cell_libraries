Cell.Grid=function(){function m(a){var b=m.prototype;this.options=a||{};this._domNode=this._xhr=null;this._sort={};this._auto_increment=0;this.options.pageDataCount=!1===this.options.pageDataCount?!1:Number.parseInt(this.options.pageDataCount)||15;this.options.selector=!!this.options.selector||!1;this._noMore=!1;q(this);r(this);t(this);u(this);v(this);b.getItemCount=function(){return $(this._domNode).find(".cell-grid-body-data tr").length};b.getItem=function(c){return $(this._domNode).find(".cell-grid-row[data-id="+
c+"]")[0]};b.getItems=function(c=!1){return $(this._domNode).find(`.cell-grid-body-data .cell-grid-row${c?':not(".disabled")':""}`).toArray()};b.getItemData=function(c,a=null){return a?$(c).data(a):$(c).data()};b.getItemsData=function(c=null,a=null){a?Array.isArray(a)||(a=[a]):a=$(this._domNode).find(".cell-grid-body-data .cell-grid-row");let b=[],d=this;$.each(a,function(a,e){(a=d.getItemData(e,c))&&(Array.isArray(a)?b=b.concat(Array.from(a)):b.push(a))});return b};b.getItemId=function(a){let b=
[];a=Array.isArray(a)?a:[a];$.each(a,function(a,c){b.push($(c).attr("data-id"))});return b};b.setSort=function(a){var b=$(this._domNode).find(".sortable[data-field-name='"+a+"']");this.reset();$(this._domNode).find(".cell-grid-header-table .sortable").not(b).removeClass("up").removeClass("down");$(b).hasClass("up")?($(b).removeClass("up").addClass("down"),b="DESC"):$(b).hasClass("down")?($(b).removeClass("down").addClass("up"),b="ASC"):($(b).addClass("down"),b="DESC");this._sort={field:a,type:b};
this.load();return this};b.setSelection=function(a,b=!0){a=$(a).not(".disabled");b&&a.removeClass("selected");a.toggleClass("selected").find(".cell-grid-row-checkbox").prop("checked",a.hasClass("selected"));h(this);this.options.onselected&&this.options.onselected.call(this,this.getSelection());return this};b.selectAll=function(){h(this)?this.removeSelection(this.getItems()):this.setSelection(this.getItems());return this};b.removeSelection=function(a,b=!0){$(this._domNode).find(".cell-grid-select-all").removeClass("selected").prop("checked",
!1);$(a).removeClass("selected").find(".cell-grid-row-checkbox").prop("checked",!1);b&&this.options.onselected&&this.options.onselected.call(this,this.getSelection());return this};b.getSelection=function(){return $(this._domNode).find(".cell-grid-row.selected").toArray()};b.getSelectionVal=function(a){return this.getItemsData(a,this.getSelection())};b.selectItem=function(a){let b=$(this._domNode).find(".cell-grid-body-data .selected").first();if(event.shiftKey&&0!==b.length&&$(a).index()!==$(b).index()){if($(a).index()<
$(b).index()){let c=b;b=a;a=c}this.removeSelection(this.getItems(),!1);this.setSelection([].concat(Array.from($(b).nextUntil(a))).concat(b[0]).concat(a[0]))}else!0===this.options.selector||event.ctrlKey||this.removeSelection(this.getItems(),!1),this.setSelection(a,!1);return this};b.addItems=function(a,b=!1){let c=this;$(a).each(function(a,d){c.addItem(d,b)});g(c);return this};b.removeItems=function(a){Array.isArray(a)||(a=[a]);let b=this;$.each(a,function(a,c){$(b._domNode).find('.cell-grid-row[data-id="'+
c+'"]').remove()});k(b);this.options.onselected&&this.options.onselected.call(this,this.getSelection());g(b);$(".tooltip").remove();return this};b.addItem=function(a,b=!1){if(!a)return this;let c=a[this.options.identify]||(a[this.options.identify]=++this._auto_increment||0);if(0<$(this._domNode).find(".cell-grid-row[data-id="+c+"]").length)return console.log("\u91cd\u8907\u7684\u8b58\u5225\u503c:"+c),this;let d=this,n=$(this._domNode).find(".cell-grid-body-table"),f=$(document.createElement("tr"));
b?f.prependTo(n):f.appendTo(n);f.addClass("cell-grid-row").attr("data-id",c).on("click",function(){!0!==d.options.selector&&d.selectItem(f);d.options.onclick&&d.options.onclick.call(d,f[0]);event.stopPropagation()}).on("dblclick",function(){d.options.ondblclick&&d.options.ondblclick.call(d,f[0])});p(d,f,a);$(this.options.fields).each(function(b,c){c.name&&!0!==c.hidden&&($(document.createElement("td")).appendTo(f).addClass("cell-grid-col").addClass(c.name.toString().replace(/_/g,"-")).addClass(c.className),
l(d,f,c,c.name,a[c.name]))});$(this._domNode).find(".cell-grid-select-all").removeClass("selected").prop({checked:!1,disabled:!1});w(this,f);g(d);return c};b.setItem=function(a,b){let c=this;Array.isArray(a)||(a=[a]);$.each(a,(a,d)=>{let e=c.getItem(d);if(!e)return console.error(`Not find item: ${d}`);p(c,e,b);$.each(b,function(a,b){let d=$c.getObjects(c.options.fields,"name",a);l(c,e,d,a,b)})});return this};b.setItemColVal=function(a,b,e){let c=this;Array.isArray(a)||(a=[a]);$.each(a,function(a,
d){a=c.getItem(d);d=$c.getObjects(c.options.fields,"name",b);$(a).data(b,e);l(c,a,d,b,e)});return this};b.setItemsSelectable=function(a,b=!0){let c=this;$(a).toggleClass("disabled",!b).find(".tiger-grid-row-selector").off("click").find(".tiger-grid-row-checkbox").prop({disabled:!b});if(b)$(a).find(".tiger-grid-row-selector").on("click",function(a){c.selectItem($(this).parent(".tiger-grid-row"));a.stopPropagation()});else $(a).removeClass("selected").find(".tiger-grid-row-checkbox").prop({checked:!1});
h(c);return this};b.renderItem=function(a,b=null){let c=this;Array.isArray(a)||(a=[a]);Array.isArray(b)||(b=[b]);let d=[];b?$(b).each(function(a,b){d.push($c.getObjects(c.options.fields,"name",b))}):d=this.options.fields;$.each(a,function(a,b){let e=c.getItem(b);$(d).each(function(a,b){a=$(e).find(`.${b.name}`);let d=$(e).data(b.name);$(a).html("").html(b.formatter?b.formatter.call(c,e,a,d):d)})});return this};b.reset=function(){this.options.onreset&&this.options.onreset.call(this);this._noMore=!1;
$(this._domNode).find(".cell-grid-body-data").empty();g(this);this.options.onselected&&this.options.onselected.call(this,this.getSelection())};b.load=function(){x(this)};b.setQuery=function(a){this.options.query=$.extend(this.options.query,a);this.reset();this.load();return this};b.reload=function(){$(".tooltip.bs-tooltip-top").remove();this.setQuery();return this};b.setUrl=function(a){this.options.url=a;this.reload();return this};b.getFirstItem=function(){return $(this._domNode).find(".cell-grid-body-data .cell-grid-row:first-child")};
b.checkDataCount=function(){g(this);return this};this.options.url?this.load():this.addItems(this.options.data)}var q=a=>{let b=void 0;a.options.replaceTo?b=$(a.options.replaceTo):(b=document.createElement("div"),$(b).appendTo(a.options.appendTo||".cell-main-container"));$(b).addClass("cell-grid").attr({id:a.options.id||null,tabindex:0}).on("keydown",function(b){b.ctrlKey&&65===b.keyCode&&(a.selectAll(),b.preventDefault())});a._domNode=b;!1!==a.options.header&&$(b).addClass("border")},t=a=>{if(!1!==
a.options.header){var b=document.createElement("div");$(b).appendTo(a._domNode).addClass("cell-grid-header");!1!==a.options.headerSticky&&$(b).addClass("position-sticky");var c=document.createElement("table");$(c).appendTo(b).addClass("cell-grid-header-table");var d=document.createElement("tr");$(d).appendTo(c).addClass("cell-grid-row");$(a.options.fields).each(function(a,b){!0!==b.hidden&&(a=document.createElement("th"),$(a).appendTo(d).attr("data-field-name",b.name).addClass("cell-grid-col").addClass(b.name.toString().replace(/_/g,
"-")).addClass(b.className).html(b.label||null),!0===b.sortable&&($(a).addClass("sortable").on("selectstart",!1),b=document.createElement("div"),$(b).appendTo(a).addClass("sorter"),$(document.createElement("span")).appendTo(b).addClass("chevron"),$(document.createElement("span")).appendTo(b).addClass("chevron")))});$(b).find(".cell-grid-row-selector").on("click",function(){a.selectAll()});return b}},u=a=>{$(a._domNode).find(".cell-grid-header-table .sortable").on("click",function(){a.setSort($(this).attr("data-field-name"))});
$(a._domNode).scrollParent().on("scroll",function(b){k(a)})},v=a=>{var b=document.createElement("div");$(b).appendTo(a._domNode).addClass("cell-grid-body");$(document.createElement("table")).appendTo(b).addClass("cell-grid-body-table");$(document.createElement("tbody")).appendTo($(a._domNode).find(".cell-grid-body-table")).addClass("cell-grid-body-data");$(document.createElement("div")).appendTo($(a._domNode).find(".cell-grid-body")).addClass("cell-grid-empty").html(a.options.emptyMessage||"No any more").hide();
b=document.createElement("div");$(b).appendTo($(a._domNode).find(".cell-grid-body")).addClass("cell-grid-loading");$(document.createElement("span")).appendTo(b).addClass("fad fa-spinner-third fa-spin");$(document.createElement("span")).appendTo(b).addClass("cell-grid-loading-message").html(a.options.loadingMessage||"Loading")},y=a=>{let b={sort:a._sort.field||void 0,sort_type:a._sort.type||void 0};!1!==a.options.pageDataCount&&(b.start=a.getItemCount()||void 0,b.count=a.options.pageDataCount||void 0);
$.extend(b,a.options.query||{});return b},x=a=>{!a.options.url||a._noMore?g(a):(a._xhr&&a._xhr.abort(),$(a._domNode).find(".cell-grid-empty").hide(),$(a._domNode).find(".cell-grid-loading").show(),a._xhr=$c.ajax.get({url:a.options.url,data:y(a),success:function(b){a.addItems(b);!b||b&&b.length<a.options.pageDataCount?a._noMore=!0:k(a);$(a._domNode).find(".cell-grid-select-all").removeClass("selected").prop({checked:!1,disabled:0===a.getItems(!0).length});a.options.onload&&a.options.onload.call(a)},
error:function(b){a.options.onerror&&a.options.onerror.call(a,b);g(a)}}))},g=a=>{let b=$(a._domNode).find(".cell-grid-empty"),c=$(a._domNode).find(".cell-grid-select-all");$(a._domNode).find(".cell-grid-loading").hide();0===a.getItemCount()?(b.show(),c.hide()):(b.hide(),c.show())},w=(a,b)=>{a.options.onaddItem&&a.options.onaddItem.call(a,b);$(b).hasClass("disabled")&&$(b).find(".cell-grid-row-selector").off("click").find(".cell-grid-row-checkbox").prop("disabled",!0);$(b).on("selectstart",!1).on("mouseover",
function(c){a.options.onmouseover&&a.options.onmouseover.call(a,c,b)})},p=(a,b,c)=>{$.each(a.options.fields,(a,e)=>{$(b).data(e.name,c[e.name])})},l=(a,b,c,d,e)=>{d=$(b).find("."+d.toString().replace(/_/g,"-"));$(d).html("").html(c.formatter?c.formatter.call(a,b,d,e):e)},k=a=>{if(!1!==a.options.pageDataCount&&a._xhr&&1!==a._xhr.readyState){var b=$(a._domNode);if(!0===b.is(":visible")){b=b.scrollParent();var [c,d,e]=[b.is(document)?$(window).height():b.innerHeight(),b.is(document)?b.height():b[0].scrollHeight,
b.scrollTop()];c+e>=d-2&&a.load()}}},r=a=>{if(!0===a.options.selector){var b=$(document.createElement("input")).attr("type","checkbox").addClass("cell-grid-select-all").hide();a.options.fields.unshift({name:"cell-grid-row-selector",label:b,formatter:function(b,d){$(document.createElement("input")).appendTo(d).attr("type","checkbox").addClass("cell-grid-row-checkbox");$(d).on("click",function(c){a.selectItem(b);c.stopPropagation()});$(d).on("dblclick",function(a){a.stopPropagation()})}})}},h=a=>{let b=
a.getItems(!0).length,c=$(a._domNode).find(".tiger-grid-select-all");if(0===b)return c.prop({checked:!1,disabled:!0}),!1;a=a.getSelection().length===b;c.prop("checked",a);return a};return m}();