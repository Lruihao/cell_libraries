Cell.Grid=function(){function n(b){var a=n.prototype;this.options=b||{};this._domNode=this._xhr=null;this._sort={};this._auto_increment=0;this.options.pageDataCount=!1===this.options.pageDataCount?!1:Number.parseInt(this.options.pageDataCount)||15;this.options.selector=!!this.options.selector||!1;this._noMore=!1;q(this);r(this);t(this);u(this);v(this);a.getItemCount=function(){return $(this._domNode).find(".cell-grid-body-data tr").length};a.getItem=function(c){return $(this._domNode).find(".cell-grid-row[data-id="+
c+"]")[0]};a.getItems=function(c=!1){return $(this._domNode).find(`.cell-grid-body-data .cell-grid-row${c?':not(".disabled")':""}`).toArray()};a.getItemData=function(c,b=null){return b?$(c).data(b):$(c).data()};a.getItemsData=function(b=null,a=null){a?Array.isArray(a)||(a=[a]):a=$(this._domNode).find(".cell-grid-body-data .cell-grid-row");let c=[],d=this;$.each(a,function(a,f){(a=d.getItemData(f,b))&&(Array.isArray(a)?c=c.concat(Array.from(a)):c.push(a))});return c};a.getItemId=function(a){let b=
[];a=Array.isArray(a)?a:[a];$.each(a,function(a,c){b.push($(c).attr("data-id"))});return b};a.setSort=function(a){var b=$(this._domNode).find(".sortable[data-field-name='"+a+"']");this.reset();$(this._domNode).find(".cell-grid-header-table .sortable").not(b).removeClass("up").removeClass("down");$(b).hasClass("up")?($(b).removeClass("up").addClass("down"),b="DESC"):$(b).hasClass("down")?($(b).removeClass("down").addClass("up"),b="ASC"):($(b).addClass("down"),b="DESC");this._sort={field:a,type:b};
this.load();return this};a.setSelection=function(a,b=!0){a=$(a).not(".disabled");b&&a.removeClass("selected");a.toggleClass("selected").find(".cell-grid-row-checkbox").prop("checked",a.hasClass("selected"));k(this);this.options.onselected&&this.options.onselected.call(this,this.getSelection());return this};a.selectAll=function(){k(this)?this.removeSelection(this.getItems()):this.setSelection(this.getItems());return this};a.removeSelection=function(a,b=!0){$(this._domNode).find(".cell-grid-select-all").removeClass("selected").prop("checked",
!1);$(a).removeClass("selected").find(".cell-grid-row-checkbox").prop("checked",!1);b&&this.options.onselected&&this.options.onselected.call(this,this.getSelection());return this};a.getSelection=function(){return $(this._domNode).find(".cell-grid-row.selected").toArray()};a.getSelectionVal=function(a){return this.getItemsData(a,this.getSelection())};a.selectItem=function(a){let b=$(this._domNode).find(".cell-grid-body-data .selected").first();if(event.shiftKey&&0!==b.length&&$(a).index()!==$(b).index()){if($(a).index()<
$(b).index()){let c=b;b=a;a=c}this.removeSelection(this.getItems(),!1);this.setSelection([].concat(Array.from($(b).nextUntil(a))).concat(b[0]).concat(a[0]))}else!0===this.options.selector||event.ctrlKey||this.removeSelection(this.getItems(),!1),this.setSelection(a,!1);return this};a.addItems=function(a,b=!1){let c=this;$(a).each(function(a,f){c.addItem(f,b)});h(c);return this};a.removeItems=function(a){Array.isArray(a)||(a=[a]);let b=this;$.each(a,function(a,c){$(b._domNode).find('.cell-grid-row[data-id="'+
c+'"]').remove()});l(b);this.options.onselected&&this.options.onselected.call(this,this.getSelection());h(b);$(".tooltip").remove();return this};a.addItem=function(a,b=!1){if(!a)return this;let c=a[this.options.identify]||(a[this.options.identify]=++this._auto_increment||0);if(0<$(this._domNode).find(".cell-grid-row[data-id="+c+"]").length)return console.log("\u91cd\u8907\u7684\u8b58\u5225\u503c:"+c),this;let e=this,d=$(this._domNode).find(".cell-grid-body-table"),g=$(document.createElement("tr"));
b?g.prependTo(d):g.appendTo(d);g.addClass("cell-grid-row").attr("data-id",c).on("click",function(){!0!==e.options.selector&&e.selectItem(g);e.options.onclick&&e.options.onclick.call(e,g[0]);event.stopPropagation()}).on("dblclick",function(){e.options.ondblclick&&e.options.ondblclick.call(e,g[0])});p(e,g,a);$(this.options.fields).each(function(b,c){c.name&&!0!==c.hidden&&($(document.createElement("td")).appendTo(g).addClass("cell-grid-col").addClass(c.name.toString().replace(/_/g,"-")).addClass(c.className),
m(e,g,c,c.name,a[c.name]))});$(this._domNode).find(".cell-grid-select-all").removeClass("selected").prop({checked:!1,disabled:!1});w(this,g);h(e);return c};a.setItem=function(a,b){let c=this;Array.isArray(a)||(a=[a]);$.each(a,(a,d)=>{let e=c.getItem(d);if(!e)return console.error(`Not find item: ${d}`);p(c,e,b);$.each(b,function(a,b){let d=$c.getObjects(c.options.fields,"name",a);m(c,e,d,a,b)})});return this};a.setItemColVal=function(a,b,f){let c=this;Array.isArray(a)||(a=[a]);$.each(a,function(a,
d){a=c.getItem(d);d=$c.getObjects(c.options.fields,"name",b);$(a).data(b,f);m(c,a,d,b,f)});return this};a.setItemsDisabled=function(a){$(a).addClass("disabled").removeClass("selected").find(".tiger-grid-row-selector").off("click").find(".tiger-grid-row-checkbox").prop({checked:!1,disabled:!0});k(this);return this};a.renderItem=function(a,b=null){let c=this;Array.isArray(a)||(a=[a]);Array.isArray(b)||(b=[b]);let e=[];b?$(b).each(function(a,b){e.push($c.getObjects(c.options.fields,"name",b))}):e=this.options.fields;
$.each(a,function(a,b){let d=c.getItem(b);$(e).each(function(a,b){a=$(d).find(`.${b.name}`);let e=$(d).data(b.name);$(a).html("").html(b.formatter?b.formatter.call(c,d,a,e):e)})});return this};a.reset=function(){this.options.onreset&&this.options.onreset.call(this);this._noMore=!1;$(this._domNode).find(".cell-grid-body-data").empty();h(this);this.options.onselected&&this.options.onselected.call(this,this.getSelection())};a.load=function(){x(this)};a.setQuery=function(a){this.options.query=$.extend(this.options.query,
a);this.reset();this.load();return this};a.reload=function(){$(".tooltip.bs-tooltip-top").remove();this.setQuery();return this};a.setUrl=function(a){this.options.url=a;this.reload();return this};a.getFirstItem=function(){return $(this._domNode).find(".cell-grid-body-data .cell-grid-row:first-child")};a.checkDataCount=function(){h(this);return this};this.options.url?this.load():this.addItems(this.options.data)}var q=b=>{let a=void 0;b.options.replaceTo?a=$(b.options.replaceTo):(a=document.createElement("div"),
$(a).appendTo(b.options.appendTo||".cell-main-container"));$(a).addClass("cell-grid").attr({id:b.options.id||null,tabindex:0}).on("keydown",function(a){a.ctrlKey&&65===a.keyCode&&(b.selectAll(),a.preventDefault())});b._domNode=a;!1!==b.options.header&&$(a).addClass("border")},t=b=>{if(!1!==b.options.header){var a=document.createElement("div");$(a).appendTo(b._domNode).addClass("cell-grid-header");!1!==b.options.headerSticky&&$(a).addClass("position-sticky");var c=document.createElement("table");$(c).appendTo(a).addClass("cell-grid-header-table");
var d=document.createElement("tr");$(d).appendTo(c).addClass("cell-grid-row");$(b.options.fields).each(function(a,b){!0!==b.hidden&&(a=document.createElement("th"),$(a).appendTo(d).attr("data-field-name",b.name).addClass("cell-grid-col").addClass(b.name.toString().replace(/_/g,"-")).addClass(b.className).html(b.label||null),!0===b.sortable&&($(a).addClass("sortable").on("selectstart",!1),b=document.createElement("div"),$(b).appendTo(a).addClass("sorter"),$(document.createElement("span")).appendTo(b).addClass("chevron"),
$(document.createElement("span")).appendTo(b).addClass("chevron")))});$(a).find(".cell-grid-row-selector").on("click",function(){b.selectAll()});return a}},u=b=>{$(b._domNode).find(".cell-grid-header-table .sortable").on("click",function(){b.setSort($(this).attr("data-field-name"))});$(b._domNode).scrollParent().on("scroll",function(a){l(b)})},v=b=>{var a=document.createElement("div");$(a).appendTo(b._domNode).addClass("cell-grid-body");$(document.createElement("table")).appendTo(a).addClass("cell-grid-body-table");
$(document.createElement("tbody")).appendTo($(b._domNode).find(".cell-grid-body-table")).addClass("cell-grid-body-data");$(document.createElement("div")).appendTo($(b._domNode).find(".cell-grid-body")).addClass("cell-grid-empty").html(b.options.emptyMessage||"No any more").hide();a=document.createElement("div");$(a).appendTo($(b._domNode).find(".cell-grid-body")).addClass("cell-grid-loading");$(document.createElement("span")).appendTo(a).addClass("fad fa-spinner-third fa-spin");$(document.createElement("span")).appendTo(a).addClass("cell-grid-loading-message").html(b.options.loadingMessage||
"Loading")},y=b=>{let a={sort:b._sort.field||void 0,sort_type:b._sort.type||void 0};!1!==b.options.pageDataCount&&(a.start=b.getItemCount()||void 0,a.count=b.options.pageDataCount||void 0);$.extend(a,b.options.query||{});return a},x=b=>{!b.options.url||b._noMore?h(b):(b._xhr&&b._xhr.abort(),$(b._domNode).find(".cell-grid-empty").hide(),$(b._domNode).find(".cell-grid-loading").show(),b._xhr=$c.ajax.get({url:b.options.url,data:y(b),success:function(a){b.addItems(a);!a||a&&a.length<b.options.pageDataCount?
b._noMore=!0:l(b);$(b._domNode).find(".cell-grid-select-all").removeClass("selected").prop({checked:!1,disabled:0===b.getItems(!0).length});b.options.onload&&b.options.onload.call(b)},error:function(a){b.options.onerror&&b.options.onerror.call(b,a);h(b)}}))},h=b=>{let a=$(b._domNode).find(".cell-grid-empty"),c=$(b._domNode).find(".cell-grid-select-all");$(b._domNode).find(".cell-grid-loading").hide();0===b.getItemCount()?(a.show(),c.hide()):(a.hide(),c.show())},w=(b,a)=>{b.options.onaddItem&&b.options.onaddItem.call(b,
a);$(a).hasClass("disabled")&&$(a).find(".cell-grid-row-selector").off("click").find(".cell-grid-row-checkbox").prop("disabled",!0);$(a).on("selectstart",!1).on("mouseover",function(c){b.options.onmouseover&&b.options.onmouseover.call(b,c,a)})},p=(b,a,c)=>{$.each(b.options.fields,(b,f)=>{$(a).data(f.name,c[f.name])})},m=(b,a,c,d,f)=>{d=$(a).find("."+d.toString().replace(/_/g,"-"));$(d).html("").html(c.formatter?c.formatter.call(b,a,d,f):f)},l=b=>{if(!1!==b.options.pageDataCount&&b._xhr&&1!==b._xhr.readyState){var a=
$(b._domNode);if(!0===a.is(":visible")){a=a.scrollParent();var [c,d,f]=[a.is(document)?$(window).height():a.innerHeight(),a.is(document)?a.height():a[0].scrollHeight,a.scrollTop()];c+f>=d-2&&b.load()}}},r=b=>{if(!0===b.options.selector){var a=$(document.createElement("input")).attr("type","checkbox").addClass("cell-grid-select-all").hide();b.options.fields.unshift({name:"cell-grid-row-selector",label:a,formatter:function(a,d){$(document.createElement("input")).appendTo(d).attr("type","checkbox").addClass("cell-grid-row-checkbox");
$(d).on("click",function(c){b.selectItem(a);c.stopPropagation()});$(d).on("dblclick",function(a){a.stopPropagation()})}})}},k=b=>{let a=b.getItems(!0).length,c=$(b._domNode).find(".tiger-grid-select-all");if(0===a)return c.prop({checked:!1,disabled:!0}),!1;b=b.getSelection().length===a;c.prop("checked",b);return b};return n}();